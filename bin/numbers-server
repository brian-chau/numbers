#!/usr/bin/env ruby

require 'sinatra'
require 'numbers'
require 'json'

set bind: '0.0.0.0'
use Rack::Deflater

fast = ENV["NUMBERS_FAST"] || "./numbers-fast"
solver = Numbers::Solver.new(Numbers::Runner.new(fast))

separator = "+"

get %r'^/numbers/target/(?<target>\d+)/numbers/(?<numbers>[0-9#{separator}]+)(?<verbose>/verbose)?$' do |target, numbers, verbose|
  target = target.to_i
  numbers = numbers.split(separator).map(&:to_i)

  if numbers != numbers.sort
    redirect to("/numbers/target/#{target}/numbers/#{numbers.sort.join separator}"), 301
  end

  data = solver.solve(numbers, target)

  unless verbose
    data.each do |d|
      d.delete :reverse_polish
      d.delete :tree1
      d.delete :tree2
      d.delete :tree3
      d.delete :tree4
    end
  end

  content_type "application/json"
  expires 300, :public
  JSON.generate(data)+"\n"
end

